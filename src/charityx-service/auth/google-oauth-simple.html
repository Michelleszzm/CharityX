<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth2 Simple Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 100px auto;
            padding: 20px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #357ae8;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h2>Google OAuth2 Test</h2>
    
    <!-- Please replace with your Google Client ID -->
    <div id="g_id_onload"
         data-client_id="989858908741-eqi3l3s0229bp8asri2nnkpasum02l30.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false"
         data-error_callback="handleError">
    </div>
    
    <div class="g_id_signin" 
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-locale="en">
    </div>
    
    <div id="result"></div>
    <div id="debugInfo" style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 11px; color: #856404;">
        <strong>Debug Information:</strong><br>
        <span id="currentOrigin"></span><br>
        <span id="clientIdInfo"></span>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        const CLIENT_ID = '989858908741-eqi3l3s0229bp8asri2nnkpasum02l30.apps.googleusercontent.com';
        const currentOrigin = window.location.origin;
        
        // Display debug information
        document.getElementById('currentOrigin').textContent = 'Current Domain: ' + currentOrigin;
        document.getElementById('clientIdInfo').textContent = 'Client ID: ' + CLIENT_ID.substring(0, 30) + '...';
        
        // Check current page protocol
        window.onload = function() {
            if (window.location.protocol === 'file:') {
                document.getElementById('result').textContent = 
                    '‚ùå Error: Cannot directly open HTML file!\n\n' +
                    'Please use local server to run:\n' +
                    '1. cd auth\n' +
                    '2. python3 -m http.server 8080\n' +
                    '3. Visit http://localhost:8080/google-oauth-simple.html';
                return;
            }
            
            // Display configuration tips
            console.log('========================================');
            console.log('üîç Google OAuth2 Configuration Check');
            console.log('========================================');
            console.log('Current access domain:', currentOrigin);
            console.log('Client ID:', CLIENT_ID);
            console.log('');
            console.log('‚ö†Ô∏è  Please configure in Google Cloud Console:');
            console.log('1. Go to: https://console.cloud.google.com/');
            console.log('2. APIs & Services ‚Üí Credentials');
            console.log('3. Edit your OAuth 2.0 Client ID');
            console.log('4. Add in "Authorized JavaScript origins":');
            console.log('   ' + currentOrigin);
            console.log('5. Save and wait 2-5 minutes to take effect');
            console.log('========================================');
            
            // Update debug information
            document.getElementById('result').textContent = 
                'üìã Configuration Check\n\n' +
                'Current Domain: ' + currentOrigin + '\n\n' +
                '‚ö†Ô∏è  If you encounter "no registered origin" error:\n' +
                'Please add in Google Cloud Console "Authorized JavaScript origins":\n' +
                currentOrigin + '\n\n' +
                'For detailed steps, please check console (F12)';
        };
        
        function handleCredentialResponse(response) {
            if (response.error) {
                let errorMsg = '‚ùå Authorization failed: ' + response.error + '\n\n';
                
                if (response.error === 'invalid_client' || response.error_description?.includes('origin')) {
                    errorMsg += 'üî¥ Error reason: Unregistered domain (no registered origin)\n\n';
                    errorMsg += '‚úÖ Solution:\n';
                    errorMsg += '1. Visit: https://console.cloud.google.com/\n';
                    errorMsg += '2. Select project: charityx-service\n';
                    errorMsg += '3. APIs & Services ‚Üí Credentials\n';
                    errorMsg += '4. Click your OAuth 2.0 Client ID (Edit)\n';
                    errorMsg += '5. Add in "Authorized JavaScript origins":\n';
                    errorMsg += '   ' + currentOrigin + '\n';
                    errorMsg += '6. Save and wait 2-5 minutes\n\n';
                    errorMsg += 'Current Domain: ' + currentOrigin + '\n';
                    errorMsg += 'Client ID: ' + CLIENT_ID;
                } else {
                    errorMsg += 'Please check Google Cloud Console configuration:\n';
                    errorMsg += '1. Does Authorized JavaScript origins include current domain\n';
                    errorMsg += '2. Current page URL: ' + currentOrigin + '\n';
                    errorMsg += '3. Is Client ID correct';
                }
                
                document.getElementById('result').textContent = errorMsg;
                console.error('OAuth error:', response);
                return;
            }
            
            // Decode JWT token
            const payload = parseJwt(response.credential);
            
            // Display result
            document.getElementById('result').textContent = 
                '‚úÖ Login successful!\n\n' +
                'User Information:\n' +
                'Name: ' + payload.name + '\n' +
                'Email: ' + payload.email + '\n' +
                'ID: ' + payload.sub + '\n\n' +
                'JWT Token (first 50 characters):\n' + response.credential.substring(0, 50) + '...';
        }
        
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        // Handle Google Identity Services initialization errors
        function handleError(error) {
            console.error('Google Identity Services error:', error);
            let errorMsg = '‚ùå Error details:\n';
            errorMsg += JSON.stringify(error, null, 2) + '\n\n';
            
            if (error.type === 'popup_closed') {
                errorMsg = 'User closed authorization window';
            } else if (error.type === 'popup_blocked') {
                errorMsg = '‚ùå Popup blocked, please allow popups and retry';
            } else if (error.message && error.message.includes('origin')) {
                errorMsg += 'üî¥ This is an unregistered domain error!\n\n';
                errorMsg += '‚úÖ Immediate solution:\n';
                errorMsg += '1. Visit: https://console.cloud.google.com/apis/credentials\n';
                errorMsg += '2. Find Client ID: ' + CLIENT_ID + '\n';
                errorMsg += '3. Click Edit\n';
                errorMsg += '4. Add in "Authorized JavaScript origins":\n';
                errorMsg += '   ' + currentOrigin + '\n';
                errorMsg += '5. Save and wait 2-5 minutes\n\n';
                errorMsg += 'üí° Tip: Use diagnose.html for detailed diagnosis';
            } else {
                errorMsg += 'Please check:\n';
                errorMsg += '1. Is Authorized JavaScript origins configured: ' + currentOrigin + '\n';
                errorMsg += '2. Is Client ID correct\n';
                errorMsg += '3. Is network connection normal\n';
                errorMsg += '4. Use diagnose.html for detailed diagnosis';
            }
            
            document.getElementById('result').textContent = errorMsg;
        }
        
        // Listen for Google Identity Services initialization errors
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('origin')) {
                console.error('Detected origin-related error:', e);
                document.getElementById('result').textContent = 
                    '‚ùå Detected unregistered domain error!\n\n' +
                    'Current Domain: ' + currentOrigin + '\n\n' +
                    'Please configure this domain in Google Cloud Console.\n' +
                    'For detailed steps, please check diagnose.html';
            }
        }, true);
    </script>
</body>
</html>
